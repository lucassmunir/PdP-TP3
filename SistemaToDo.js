// SistemaToDo.js

const GestorDeTareas = require('./GestorDeTareas');
const { Tarea, EnumsTarea, normalizarEnum } = require('./Tarea');
const { preguntar, cerrarCLI, mostrarMenu, pausar } = require('./UtilidadesCLI');

class SistemaToDo {
    constructor() {
        this.gestor = new GestorDeTareas();
    }

    // --- MENÃš PRINCIPAL ---
    async menuPrincipal() {
        while (true) {
            console.clear();
            console.log('Â¡Hola Lucas!');

            const opciones = {
                1: 'Ver Mis Tareas.',
                2: 'Buscar una Tarea.',
                3: 'Agregar una Tarea.',
            };

            const opcion = await mostrarMenu('MenÃº Principal', opciones, true); // true = 0 para Salir

            if (opcion === null) {
                console.log('\nÂ¡Gracias por usar el sistema! Hasta pronto.');
                return; // Salir
            }

            switch (opcion) {
                case '1':
                    await this.menuVerTareas();
                    break;
                case '2':
                    await this.menuBuscarTarea();
                    break;
                case '3':
                    await this.menuAgregarTarea();
                    break;
                default:
                    // Ya validado, pero por seguridad
                    break;
            }
        }
    }

    // --- MENÃš AGREGAR TAREA (OpciÃ³n 4) ---
    async menuAgregarTarea() {
        console.clear();
        console.log('--- Creando una nueva tarea ---');

        try {
            // 1. TÃ­tulo (Obligatorio)
            let titulo = await preguntar('1. Ingresa el TÃ­tulo');
            while (!titulo || titulo.length > 100) {
                console.log('[ERROR] TÃ­tulo invÃ¡lido. Debe ser un texto corto (mÃ¡x 100 caracteres).');
                titulo = await preguntar('1. Ingresa el TÃ­tulo');
            }

            // 2. DescripciÃ³n (Opcional)
            const descripcion = await preguntar('2. Ingresa la descripciÃ³n (Opcional)');

            // 3. Estado (Por defecto: Pendiente)
            const opcionesEstado = Object.values(EnumsTarea.ESTADO).map(e => `[${e.char}] ${e.texto}`).join(' / ');
            const estadoInput = await preguntar(`3. Estado (${opcionesEstado}) [P] `) || 'p'; // Por defecto 'p'
            const estado = normalizarEnum(EnumsTarea.ESTADO, estadoInput);

            // 4. Dificultad (Por defecto: FÃ¡cil)
            const opcionesDificultad = Object.values(EnumsTarea.DIFICULTAD).map(e => `[${e.clave}] ${e.texto}`).join(' / ');
            const dificultadInput = await preguntar(`4. Dificultad (${opcionesDificultad}) [1] `) || '1'; // Por defecto '1'
            const dificultad = normalizarEnum(EnumsTarea.DIFICULTAD, dificultadInput);
            
            // 5. Vencimiento 
            let fechaVencimiento = null;
            const vencimientoInput = await preguntar('5. Vencimiento (dd/mm/aaaa) (Opcional)');
            if (vencimientoInput) {
                const parts = vencimientoInput.split('/');
                // Intento de parsear la fecha (Date(aÃ±o, mes-1, dÃ­a))
                const tempDate = new Date(parts[2], parts[1] - 1, parts[0]);
                if (!isNaN(tempDate)) {
                    fechaVencimiento = tempDate;
                } else {
                    console.log('[AVISO] Formato de fecha de vencimiento invÃ¡lido. Se omite.');
                }
            }

            // 6. Costo (Requisito 1)
            let costo = await preguntar('6. Ingresa el Costo (Opcional)');
            costo = costo ? parseFloat(costo) : null;
            if (isNaN(costo)) costo = null;


            // CreaciÃ³n y guardado
            const nuevaTarea = new Tarea(titulo, descripcion, estado.char, dificultad.char, fechaVencimiento, costo);
            this.gestor.agregarTarea(nuevaTarea);
            
            console.log('\nÂ¡Datos guardados!'); // Requisito (Imagen 11)
            await pausar();

        } catch (error) {
            console.error(`\n[ERROR GRAVE] ${error.message}`);
            await pausar();
        }
    }

    // --- MENÃš VER MIS TAREAS (OpciÃ³n 1) ---
    // SistemaToDo.js - MÃ©todo menuVerTareas (Â¡CORREGIDO!)

    async menuVerTareas() {
        
        // ðŸš¨ CÃ“DIGO FALTANTE: DEBES DEFINIR ESTE OBJETO
        const opciones = {
            1: 'Todas',
            2: 'Pendientes',
            3: 'En curso',
            4: 'Terminadas',
            // Opciones 5 a 9 se podrÃ­an usar para el BONUS de OrdenaciÃ³n
        };
        // ---------------------------------------------

        const opcionesFiltro = {
            1: null, // Todas
            2: EnumsTarea.ESTADO.PENDIENTE.char,
            3: EnumsTarea.ESTADO.EN_CURSO.char,
            4: EnumsTarea.ESTADO.TERMINADA.char,
        };

        const opcion = await mostrarMenu('MenÃº Ver Mis Tareas', opciones, true); 

        // La soluciÃ³n previa para el null es correcta, Ãºsala:
        if (opcion !== null && opcionesFiltro.hasOwnProperty(opcion)) {
            await this.mostrarListadoTareas(opcionesFiltro[opcion]);
        }
    }
    
    // --- MENÃš BUSCAR TAREA (OpciÃ³n 2) ---
    async menuBuscarTarea() {
        console.clear();
        console.log('--- BÃºsqueda de Tareas ---');

        const cadenaBusqueda = await preguntar('Introduce el tÃ­tulo de una tarea para buscarla');

        const resultados = this.gestor.buscarTareasPorTitulo(cadenaBusqueda);

        if (resultados.length === 0) {
            console.log('\nNo hay tareas relacionadas con la bÃºsqueda.'); // Requisito (Imagen 10)
            await pausar();
        } else {
            await this.mostrarListadoTareas(null, resultados);
        }
    }


    // --- LISTADO DE TAREAS Y SELECCIÃ“N (ImÃ¡genes 5, 10) ---
    async mostrarListadoTareas(filtroClave = null, tareasPreFiltradas = null) {
        let tareas = tareasPreFiltradas || this.gestor.filtrarTareas(filtroClave);

        if (tareas.length === 0) {
            console.clear();
            console.log('\nNo hay tareas para mostrar en este filtro.');
            await pausar();
            return;
        }

        while (true) {
            console.clear();
            console.log('--- Listado de Tareas ---');
            
            // BONUS: OrdenaciÃ³n (Simple, por defecto TÃ­tulo)
            console.log(`\nOrden: [T] TÃ­tulo | [V] Vencimiento | [C] CreaciÃ³n. (Actual: TÃ­tulo)`);
            const opcionOrden = await preguntar('Elige un criterio de ordenaciÃ³n (o ENTER para continuar)');
            
            let criterioOrden = 'titulo';
            if (opcionOrden === 'v' || opcionOrden === 'V') criterioOrden = 'vencimiento';
            if (opcionOrden === 'c' || opcionOrden === 'C') criterioOrden = 'creacion';

            tareas = this.gestor.ordenarTareas(tareas, criterioOrden);
            
            console.log('\nEstas son todas tus tareas:');
            tareas.forEach((t, index) => {
                console.log(`[${index + 1}] ${t.titulo} (Estado: ${t.estado.texto})`);
            });

            // NavegaciÃ³n (Imagen 5)
            const eleccion = await preguntar('\nÂ¿Deseas ver los detalles de alguna? Introduce el nÃºmero para verla o 0 para volver');

            if (eleccion === '0') {
                return; // Volver al menÃº anterior
            }

            const indice = parseInt(eleccion);
            const tareaSeleccionada = this.gestor.obtenerTareaPorIndice(indice, tareas);

            if (tareaSeleccionada) {
                await this.menuDetallesTarea(tareaSeleccionada);
            } else {
                console.log('\n[ERROR] El nÃºmero de tarea no es vÃ¡lido.'); // Requisito de validaciÃ³n
                await pausar();
            }
        }
    }

    // --- MENÃš DETALLES DE TAREA (ImÃ¡genes 6, 7) ---
    async menuDetallesTarea(tarea) {
        while (true) {
            console.clear();
            console.log('--- Detalles de Tarea ---');
            
            // Mostrar todos los detalles requeridos (Imagen 6)
            console.log(tarea.aCadenaDeVisualizacion()); 

            const eleccion = await preguntar('\nSi deseas editarla, presiona E, o presiona 0 para volver'); // Requisito (Imagen 6)

            if (eleccion === '0') {
                return; // Volver al listado
            }

            if (eleccion.toUpperCase() === 'E') {
                await this.menuEdicionTarea(tarea);
                return; // Al editar y guardar, volvemos a mostrar el listado actualizado
            } else {
                console.log('\n[ERROR] OpciÃ³n no vÃ¡lida.');
                await pausar();
            }
        }
    }

    // --- MENÃš EDICIÃ“N DE TAREA (ImÃ¡genes 8, 9) ---
    async menuEdicionTarea(tarea) {
        console.clear();
        console.log(`--- Editando la tarea: ${tarea.titulo} ---`);
        console.log(' - Si deseas mantener el valor, simplemente dÃ©jalo en blanco.');
        console.log(' - Si deseas dejar sin valor (vaciar), escribe un espacio ( " " ).');

        const actualizaciones = {};

        // 1. TÃ­tulo
        let tituloInput = await preguntar(`1. TÃ­tulo (Actual: ${tarea.titulo})`);
        if (tituloInput !== '') actualizaciones.titulo = tituloInput;

        // 2. DescripciÃ³n
        const descripcionInput = await preguntar(`2. DescripciÃ³n (Actual: ${tarea.descripcion || 'Sin Datos'})`);
        if (descripcionInput !== '') actualizaciones.descripcion = descripcionInput; // Si es ' ', se vacÃ­a en el gestor

        // 3. Estado
        const opcionesEstado = Object.values(EnumsTarea.ESTADO).map(e => `[${e.char}] ${e.texto}`).join(' / ');
        const estadoInput = await preguntar(`3. Estado (Actual: ${tarea.estado.texto}) (${opcionesEstado})`);
        if (estadoInput !== '') actualizaciones.estado = estadoInput;

        // 4. Dificultad
        const opcionesDificultad = Object.values(EnumsTarea.DIFICULTAD).map(e => `[${e.clave}] ${e.texto}`).join(' / ');
        const dificultadInput = await preguntar(`4. Dificultad (Actual: ${tarea.dificultad.texto}) (${opcionesDificultad})`);
        if (dificultadInput !== '') actualizaciones.dificultad = dificultadInput;

        // 5. Vencimiento (Editable)
        let vencimientoInput = await preguntar(`5. Vencimiento (Actual: ${tarea.fechaVencimiento ? tarea.fechaVencimiento.toLocaleDateString('es-AR') : 'Sin Datos'}) (dd/mm/aaaa para cambiar, " " para vaciar)`);
        
        if (vencimientoInput === ' ') {
            actualizaciones.fechaVencimiento = null;
        } else if (vencimientoInput !== '') {
            const parts = vencimientoInput.split('/');
            const tempDate = new Date(parts[2], parts[1] - 1, parts[0]);
            if (!isNaN(tempDate)) {
                actualizaciones.fechaVencimiento = tempDate;
            } else {
                console.log('\n[AVISO] Formato de fecha invÃ¡lido. Se omite la actualizaciÃ³n del vencimiento.');
            }
        }

        // 6. Costo (No se vio en la ediciÃ³n, pero lo incluimos por coherencia)
        let costoInput = await preguntar(`6. Costo (Actual: ${tarea.costo !== null ? tarea.costo : 'Sin Datos'})`);
        if (costoInput !== '') {
            const nuevoCosto = costoInput.trim() === ' ' ? null : parseFloat(costoInput);
            if (!isNaN(nuevoCosto)) {
                actualizaciones.costo = nuevoCosto;
            }
        }
        
        // Aplicar la ediciÃ³n
        this.gestor.editarTarea(tarea, actualizaciones);

        console.log('\nÂ¡Datos guardados!'); // Requisito (Imagen 8)
        await pausar();
    }
}

module.exports = SistemaToDo;